<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ØªØ·ÙˆØ± - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ±ÙÙŠÙ‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap');
        body { font-family: 'Cairo', sans-serif; background-color: #030712; color: white; margin: 0; overflow-x: hidden; }
        .game-card:active { transform: scale(0.95); }
        .memory-card { transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .memory-card.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; border-radius: 0.75rem; }
        .card-back { background-color: #1e1b4b; transform: rotateY(180deg); }
        .card-front { background-color: #1f2937; }
        .hidden-section { display: none !important; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-[100] bg-gray-950 flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500"></div>
    </div>

    <!-- Main Container -->
    <div id="app-container" class="min-h-screen pb-20">
        
        <!-- Header -->
        <header class="p-4 bg-gray-900 border-b border-gray-800 flex justify-between items-center sticky top-0 z-50">
            <div class="flex items-center gap-2">
                <i class="fas fa-gamepad text-blue-500 text-2xl"></i>
                <h1 class="text-xl font-black">Ø¹Ø§Ù„Ù… Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h1>
            </div>
            <div id="user-balance-header" class="bg-gray-800 px-4 py-1 rounded-full flex items-center gap-2 border border-yellow-600/30">
                <i class="fas fa-coins text-yellow-500"></i>
                <span id="header-balance-val" class="font-mono font-bold text-yellow-400">0</span>
            </div>
        </header>

        <!-- Dynamic Content -->
        <main id="main-content" class="p-4 max-w-4xl mx-auto">
            <!-- Sections will be injected here -->
        </main>

        <!-- Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 p-2 flex justify-around items-center z-40">
            <button onclick="showSection('home')" class="nav-btn text-blue-500 flex flex-col items-center">
                <i class="fas fa-gamepad"></i>
                <span class="text-[10px] mt-1">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</span>
            </button>
            <button onclick="showSection('profile')" class="nav-btn text-gray-400 flex flex-col items-center">
                <i class="fas fa-user"></i>
                <span class="text-[10px] mt-1">Ø­Ø³Ø§Ø¨ÙŠ</span>
            </button>
            <button onclick="logout()" class="text-red-400 flex flex-col items-center">
                <i class="fas fa-sign-out-alt"></i>
                <span class="text-[10px] mt-1">Ø®Ø±ÙˆØ¬</span>
            </button>
        </nav>
    </div>

    <!-- Admin Panel Structure -->
    <div id="admin-panel" class="min-h-screen bg-gray-950 text-white p-4 hidden-section">
        <header class="flex justify-between items-center mb-8 border-b border-gray-800 pb-4">
            <div>
                <h1 class="text-2xl font-black text-red-500">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h1>
                <p class="text-gray-400 text-sm">Ø£Ù‡Ù„Ø§Ù‹ ÙŠØ§ Ù…Ø­Ù…Ø¯ØŒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø© Ù…ØªØ§Ø­Ø© Ø§Ù„Ø¢Ù†</p>
            </div>
            <button onclick="logout()" class="bg-red-900/30 text-red-500 p-2 rounded-lg"><i class="fas fa-power-off"></i></button>
        </header>
        <div class="mb-6 relative">
            <i class="fas fa-search absolute left-3 top-3 text-gray-500"></i>
            <input type="text" id="user-search" oninput="filterUsers()" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…..." class="w-full bg-gray-900 border border-gray-800 rounded-xl py-3 pl-10 pr-4 outline-none focus:ring-2 focus:ring-blue-500 text-right">
        </div>
        <div class="bg-gray-900 rounded-2xl overflow-x-auto">
            <table class="w-full text-right border-collapse">
                <thead class="bg-gray-800 text-gray-400 text-sm">
                    <tr>
                        <th class="p-4">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th class="p-4">Ø§Ù„Ø±ØµÙŠØ¯</th>
                        <th class="p-4">Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="divide-y divide-gray-800"></tbody>
            </table>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black/80 hidden-section z-[100] flex items-center justify-center p-4">
        <!-- Content injected dynamically -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, increment, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'games-hub-html-v1';
        const ADMIN_EMAIL = "ahmedfouad01278837444@gmail.com";

        let currentUser = null;
        let userData = { balance: 0, isAdmin: false };
        let allUsers = [];

        // --- AUTH LOGIC ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
            } else {
                await signInAnonymously(auth);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const isAdmin = user.email === ADMIN_EMAIL;
                userData.isAdmin = isAdmin;

                // Sync Profile
                const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
                onSnapshot(userDocRef, (snap) => {
                    if (snap.exists()) {
                        userData = { ...snap.data(), isAdmin };
                        document.getElementById('header-balance-val').innerText = userData.balance;
                        if (isAdmin) renderAdmin(); else showSection('home');
                    } else {
                        const initial = { balance: 100, email: user.email || 'guest' };
                        setDoc(userDocRef, initial);
                    }
                    document.getElementById('loading-overlay').classList.add('hidden-section');
                });

                // Update Public record
                if (!isAdmin) {
                    const publicRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_users', user.uid);
                    setDoc(publicRef, { uid: user.uid, email: user.email || 'Guest', balance: 0 }, { merge: true });
                } else {
                    // Admin: fetch all users
                    onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'all_users'), (snap) => {
                        allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        renderAdmin();
                    });
                }
            } else {
                window.location.reload();
            }
        });

        // --- UI ROUTING ---
        window.showSection = (name) => {
            const main = document.getElementById('main-content');
            const admin = document.getElementById('admin-panel');
            const appCont = document.getElementById('app-container');

            if (userData.isAdmin) {
                appCont.classList.add('hidden-section');
                admin.classList.remove('hidden-section');
                return;
            }

            appCont.classList.remove('hidden-section');
            admin.classList.add('hidden-section');

            if (name === 'home') {
                main.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-2xl shadow-xl">
                            <h2 class="text-2xl font-bold mb-2 text-right">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ù…Ø­Ù…Ø¯!</h2>
                            <p class="text-blue-100 text-right">Ø§Ø®ØªØ± Ù„Ø¹Ø¨ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div onclick="startClicker()" class="game-card bg-gray-900 border border-gray-800 p-5 rounded-2xl flex flex-row-reverse items-center gap-4 cursor-pointer hover:border-blue-500">
                                <div class="bg-orange-500 p-4 rounded-xl"><i class="fas fa-mouse-pointer text-xl"></i></div>
                                <div class="text-right">
                                    <h3 class="font-bold">ØªØ­Ø¯ÙŠ Ø§Ù„Ù†Ù‚Ø±Ø§Øª</h3>
                                    <p class="text-gray-400 text-sm">Ø§Ø±Ø¨Ø­ Ù…Ø¹ ÙƒÙ„ Ø¶ØºØ·Ø©</p>
                                </div>
                            </div>
                            <div onclick="startMemory()" class="game-card bg-gray-900 border border-gray-800 p-5 rounded-2xl flex flex-row-reverse items-center gap-4 cursor-pointer hover:border-blue-500">
                                <div class="bg-indigo-500 p-4 rounded-xl"><i class="fas fa-brain text-xl"></i></div>
                                <div class="text-right">
                                    <h3 class="font-bold">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°Ø§ÙƒØ±Ø©</h3>
                                    <p class="text-gray-400 text-sm">Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ ÙˆØ§Ø±Ø¨Ø­ Ø§Ù„ÙƒØ«ÙŠØ±</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (name === 'profile') {
                main.innerHTML = `
                    <div class="text-center bg-gray-900 p-8 rounded-2xl border border-gray-800">
                        <div class="w-20 h-20 bg-blue-600 rounded-full mx-auto flex items-center justify-center mb-4"><i class="fas fa-user text-3xl"></i></div>
                        <h3 class="text-xl font-bold">${currentUser.email || 'Ù„Ø§Ø¹Ø¨ Ø²Ø§Ø¦Ø±'}</h3>
                        <p class="text-gray-500 text-sm mb-6">ID: ${currentUser.uid.slice(0,10)}</p>
                        <div class="bg-gray-800 p-4 rounded-xl flex justify-between items-center">
                            <span class="text-gray-400">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø­</span>
                            <span class="text-2xl font-black text-yellow-500">${userData.balance}</span>
                        </div>
                    </div>`;
            }
        };

        // --- GAME LOGIC ---
        let clickerSession = 0;
        window.startClicker = () => {
            clickerSession = 0;
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <div class="flex flex-col items-center py-10">
                    <button onclick="showSection('home')" class="self-start text-blue-500 font-bold mb-8">â† Ø±Ø¬ÙˆØ¹</button>
                    <div class="relative mb-12">
                        <div class="absolute -inset-4 bg-blue-500/20 blur-xl rounded-full animate-pulse"></div>
                        <button id="big-button" class="relative w-48 h-48 bg-blue-600 rounded-full shadow-[0_10px_0_rgb(30,58,138)] active:translate-y-2 active:shadow-none transition-all flex items-center justify-center">
                            <i class="fas fa-mouse-pointer text-5xl"></i>
                        </button>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-500 text-sm tracking-widest uppercase">Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©</p>
                        <p id="session-count" class="text-6xl font-black">0</p>
                    </div>
                </div>`;
            
            document.getElementById('big-button').onclick = async () => {
                clickerSession++;
                document.getElementById('session-count').innerText = clickerSession;
                await updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data'), { balance: increment(1) });
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid), { balance: increment(1) });
            };
        };

        window.startMemory = () => {
            const emojis = ['ğŸ®', 'ğŸ•¹ï¸', 'ğŸ‘¾', 'ğŸš€', 'ğŸ’', 'ğŸ”¥', 'â­', 'ğŸ€'];
            let board = [...emojis, ...emojis].sort(() => Math.random() - 0.5);
            let flipped = [];
            let solved = [];
            
            const main = document.getElementById('main-content');
            main.innerHTML = `
                <div class="flex flex-col items-center">
                    <button onclick="showSection('home')" class="self-start text-blue-500 font-bold mb-4">â† Ø±Ø¬ÙˆØ¹</button>
                    <div class="grid grid-cols-4 gap-3" id="memory-grid"></div>
                </div>`;
            
            const grid = document.getElementById('memory-grid');
            board.forEach((emoji, i) => {
                const card = document.createElement('div');
                card.className = "relative w-16 h-20 memory-card";
                card.innerHTML = `
                    <div class="card-front"><i class="fas fa-question text-gray-600"></i></div>
                    <div class="card-back text-2xl">${emoji}</div>
                `;
                card.onclick = () => {
                    if (flipped.length === 2 || flipped.includes(i) || solved.includes(i)) return;
                    card.classList.add('flipped');
                    flipped.push(i);
                    
                    if (flipped.length === 2) {
                        const [idx1, idx2] = flipped;
                        if (board[idx1] === board[idx2]) {
                            solved.push(idx1, idx2);
                            flipped = [];
                            updateDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'data'), { balance: increment(10) });
                            updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', currentUser.uid), { balance: increment(10) });
                            if (solved.length === board.length) alert("Ø£Ø­Ø³Ù†Øª! Ø±Ø¨Ø­Øª Ù…ÙƒØ§ÙØ£Ø© ÙƒØ¨Ø±Ù‰");
                        } else {
                            setTimeout(() => {
                                document.querySelectorAll('.memory-card')[idx1].classList.remove('flipped');
                                document.querySelectorAll('.memory-card')[idx2].classList.remove('flipped');
                                flipped = [];
                            }, 1000);
                        }
                    }
                };
                grid.appendChild(card);
            });
        };

        // --- ADMIN ACTIONS ---
        function renderAdmin() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = allUsers.map(u => `
                <tr class="hover:bg-gray-800/50 transition">
                    <td class="p-4">
                        <div class="font-bold text-sm">${u.email}</div>
                        <div class="text-[9px] text-gray-500">${u.uid.slice(0,15)}...</div>
                    </td>
                    <td class="p-4 text-yellow-500 font-mono font-bold">${u.balance}</td>
                    <td class="p-4">
                        <button onclick="openBalanceModal('${u.uid}', '${u.email}')" class="bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        window.openBalanceModal = (uid, email) => {
            const modal = document.getElementById('modal-container');
            modal.classList.remove('hidden-section');
            modal.innerHTML = `
                <div class="bg-gray-900 border border-gray-800 p-6 rounded-2xl w-full max-w-xs text-right">
                    <h3 class="font-bold text-lg mb-2">Ø´Ø­Ù† Ø±ØµÙŠØ¯</h3>
                    <p class="text-gray-400 text-xs mb-4">${email}</p>
                    <input type="number" id="charge-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº..." class="w-full bg-gray-800 p-3 rounded-xl mb-4 outline-none border border-gray-700 focus:border-blue-500">
                    <div class="flex gap-2">
                        <button id="confirm-charge" class="flex-1 bg-green-600 py-2 rounded-xl font-bold">ØªØ£ÙƒÙŠØ¯</button>
                        <button onclick="document.getElementById('modal-container').classList.add('hidden-section')" class="flex-1 bg-gray-700 py-2 rounded-xl">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </div>`;
            
            document.getElementById('confirm-charge').onclick = async () => {
                const amount = parseInt(document.getElementById('charge-amount').value);
                if (isNaN(amount)) return;
                
                await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data'), { balance: increment(amount) });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_users', uid), { balance: increment(amount) });
                
                modal.classList.add('hidden-section');
            };
        };

        window.filterUsers = () => {
            const term = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(u => u.email.toLowerCase().includes(term));
            const tbody = document.getElementById('users-table-body');
            // Re-render only filtered
            tbody.innerHTML = filtered.map(u => `
                <tr class="hover:bg-gray-800/50 transition">
                    <td class="p-4">
                        <div class="font-bold text-sm">${u.email}</div>
                        <div class="text-[9px] text-gray-500">${u.uid.slice(0,15)}...</div>
                    </td>
                    <td class="p-4 text-yellow-500 font-mono font-bold">${u.balance}</td>
                    <td class="p-4">
                        <button onclick="openBalanceModal('${u.uid}', '${u.email}')" class="bg-blue-600 w-8 h-8 rounded-full flex items-center justify-center">
                            <i class="fas fa-plus text-xs"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        };

        window.logout = () => signOut(auth).then(() => window.location.reload());

        // Launch
        initAuth();
    </script>
</body>
</html>

